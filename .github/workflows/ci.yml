name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# Cambia esto por el nombre real de tu paquete Python (para coverage)
env:
  PACKAGE_NAME: "vatuta"

jobs:
  pre-commit:
    name: Lint & static checks (pre-commit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry & pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install poetry pre-commit

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: Run pre-commit on all files
        run: |
          pre-commit run --all-files

  tests:
    name: Build, test & artifacts (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: Run tests with coverage (Pytest)
        run: |
          poetry run pytest \
            --cov="${{ env.PACKAGE_NAME }}" \
            --cov-report=xml \
            --junitxml=pytest-report.xml

      - name: Enforce minimum coverage
        run: |
          poetry run coverage report --fail-under=25

      - name: Build package
        run: |
          poetry build

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: coverage.xml

      - name: Upload test report (JUnit)
        uses: actions/upload-artifact@v4
        with:
          name: junit-report-${{ matrix.python-version }}
          path: pytest-report.xml

      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: python-package-${{ matrix.python-version }}
          path: dist/

  security_sca:
    name: Dependency security audit (pip-audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry & pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install poetry pip-audit

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: Run pip-audit (JSON report)
        run: |
          poetry run pip-audit -f json -o pip-audit.json

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: pip-audit.json

  sast_bandit:
    name: SAST - Bandit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run Bandit (JSON report)
        run: |
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  sast_semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep (CI rules, SARIF)
        run: |
          semgrep --config p/ci --sarif-output=semgrep.sarif || true

      - name: Upload Semgrep report (SARIF)
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sast
          path: semgrep.sarif

  codespell:
    name: Check spelling (codespell)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run codespell
        uses: codespell-project/actions-codespell@v2
        with:
          path: src tests
