name: CI

on:
  push:
    branches: ["main"]
    tags: ["*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  PACKAGE_NAME: "vatuta"

jobs:
  dco:
    name: DCO (Signed-off-by)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check Signed-off-by on all PR commits
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              { owner, repo, pull_number, per_page: 100 }
              );

            const missing = [];
            for (const c of commits) {
              const msg = c.commit && c.commit.message ? c.commit.message : "";
              if (!/^\s*Signed-off-by:\s+.+<.+>\s*$/mi.test(msg)) {
                  missing.push(`${c.sha.substring(0, 7)}: ${msg.split('\n')[0]}`);
              }
            }

            if (missing.length) {
              core.setFailed(
                `DCO sign-off missing in ${missing.length} commit(s):\n` +
                missing.map(x => `- ${x}`).join('\n') +
                `\n\nFix: rebase/amend commits adding sign-off:\n` +
                `  git commit -s ...\n` +
                `  # or for existing commits:\n` +
                `  git commit --amend -s\n`
              );
            } else {
              core.info(`All ${commits.length} commits contain Signed-off-by.`);
            }
  pre-commit:
    name: Lint & static checks (pre-commit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry & pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install poetry pre-commit

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: Run pre-commit on all files
        run: |
          pre-commit run --all-files

  tests:
    name: Build, test & artifacts (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: Run tests with coverage (Pytest)
        run: |
          poetry run pytest \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=pytest-report.xml

      - name: Enforce minimum coverage
        run: |
          poetry run coverage report --fail-under=25

      - name: Build package
        run: |
          poetry build

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: coverage.xml

      - name: Upload test report (JUnit)
        uses: actions/upload-artifact@v4
        with:
          name: junit-report-${{ matrix.python-version }}
          path: pytest-report.xml

      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: python-package-${{ matrix.python-version }}
          path: dist/

      - name: Upload coverage report (HTML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-${{ matrix.python-version }}
          path: htmlcov/


  security_sca:
    name: Dependency security audit (pip-audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry & pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install poetry pip-audit

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi

      - name: Build pip-audit ignore flags from .pip-audit-ignore
        run: |
          FLAGS=$(grep -v '^\s*#' .pip-audit-ignore | grep -v '^\s*$' | sed 's/^/--ignore-vuln /' | tr '\n' ' ')
          echo "PIP_AUDIT_IGNORE_FLAGS=$FLAGS" >> "$GITHUB_ENV"

      - name: Generate pip-audit text report
        run: |
          poetry run pip-audit ${{ env.PIP_AUDIT_IGNORE_FLAGS }} --desc > pip-audit.txt || true

      - name: Run pip-audit (JSON report)
        run: |
          poetry run pip-audit ${{ env.PIP_AUDIT_IGNORE_FLAGS }} -f json -o pip-audit.json

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: |
            pip-audit.json
            pip-audit.txt

  sast_bandit:
    name: SAST - Bandit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Generate Bandit HTML report
        run: |
          bandit -r . -f html -o bandit-report.html || true

      - name: Run Bandit (JSON report)
        run: |
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: |
            bandit-report.json
            bandit-report.html

  sast_semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep (CI rules, SARIF & Text)
        run: |
          semgrep --config p/ci --sarif-output=semgrep.sarif --text > semgrep.txt || true

      - name: Upload Semgrep report (SARIF & Text)
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sast
          path: |
            semgrep.sarif
            semgrep.txt

  codespell:
    name: Check spelling (codespell)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run codespell
        uses: codespell-project/actions-codespell@v2
        with:
          path: src tests

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.cyclonedx.json

  complexity:
    name: Code Complexity (Radon)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Radon
        run: pip install radon

      - name: Run Radon CC
        run: radon cc src -a -na > radon-cc.txt

      - name: Run Radon MI
        run: radon mi src > radon-mi.txt

      - name: Upload Radon CC Report
        uses: actions/upload-artifact@v4
        with:
          name: radon-cc-report
          path: radon-cc.txt

      - name: Upload Radon MI Report
        uses: actions/upload-artifact@v4
        with:
          name: radon-mi-report
          path: radon-mi.txt

  duplication:
    name: Code Duplication (jscpd)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run jscpd
        run: npx jscpd src --min-tokens 50 --min-lines 5 --reporters json,html,console --output ./jscpd-report

      - name: Upload jscpd Report
        uses: actions/upload-artifact@v4
        with:
          name: jscpd-report
          path: jscpd-report/

  quality:
    name: Code Quality (Mypy & Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry & Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install --no-interaction --no-ansi
          poetry run pip install lxml # Required for mypy html report

      - name: Run Mypy (HTML Report)
        run: |
          poetry run mypy src --html-report mypy_report || true

      - name: Upload Mypy Report
        uses: actions/upload-artifact@v4
        with:
          name: mypy-report
          path: mypy_report/

      - name: Run Ruff (Text Report)
        run: |
          poetry run ruff check src --output-format=json --output-file=ruff-report.json || true
          poetry run ruff check src --output-format=full > ruff-report.txt || true # Use redirect for text output

      - name: Upload Ruff Report
        uses: actions/upload-artifact@v4
        with:
          name: ruff-report
          path: |
            ruff-report.json
            ruff-report.txt
